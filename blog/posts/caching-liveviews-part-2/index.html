<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Caching Liveviews - Part 2: Publicly caching private Liveviews - Tangui&#39;s blog</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="In Part 1: The road to HTTP-caching Liveviews, we&rsquo;ve
succeeded in caching the initial rendering of Liveviews.
For this we had to:

disable CSRF token check, using a modified version of Phoenix
disable sending the CSRF token when establishing the websocket connection
configure a Plug that sets the cache-control header
and eventually configure PlugHTTPCache

So far we succeeded in caching Liveviews that render public content. Caching private content with
plug_http_cache or a CDN makes little sense, as the goal of a shared cache is to reuse response
generated for a user A to all other users." />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="https://svground.fr/blog/posts/caching-liveviews-part-2/">
  <meta property="og:site_name" content="Tangui&#39;s blog">
  <meta property="og:title" content="Caching Liveviews - Part 2: Publicly caching private Liveviews">
  <meta property="og:description" content="In Part 1: The road to HTTP-caching Liveviews, we’ve succeeded in caching the initial rendering of Liveviews.
For this we had to:
disable CSRF token check, using a modified version of Phoenix disable sending the CSRF token when establishing the websocket connection configure a Plug that sets the cache-control header and eventually configure PlugHTTPCache So far we succeeded in caching Liveviews that render public content. Caching private content with plug_http_cache or a CDN makes little sense, as the goal of a shared cache is to reuse response generated for a user A to all other users.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-05T01:39:41+01:00">
    <meta property="article:modified_time" content="2024-09-05T01:39:41+01:00">
    <meta property="article:tag" content="HTTP Caching">
    <meta property="article:tag" content="Elixir">
    <meta property="article:tag" content="Liveview">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Caching Liveviews - Part 2: Publicly caching private Liveviews">
  <meta name="twitter:description" content="In Part 1: The road to HTTP-caching Liveviews, we’ve succeeded in caching the initial rendering of Liveviews.
For this we had to:
disable CSRF token check, using a modified version of Phoenix disable sending the CSRF token when establishing the websocket connection configure a Plug that sets the cache-control header and eventually configure PlugHTTPCache So far we succeeded in caching Liveviews that render public content. Caching private content with plug_http_cache or a CDN makes little sense, as the goal of a shared cache is to reuse response generated for a user A to all other users.">
<script src="https://svground.fr/blog/js/feather.min.js"></script>
	
	
        <link href="https://svground.fr/blog/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://svground.fr/blog/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />

	
	

	
	

	
		
		
		<link rel="stylesheet" type="text/css" href="https://svground.fr/blog/css/custom.d287809400cafea254e83ff2007e8eae4bcba882165ffd064d74d2483d34b156.css">
		
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://svground.fr/">Tangui&#39;s blog</a>
	</div>
	<nav>
		
		<a href="/blog/">Home</a>
		
		<a href="/blog/posts">All posts</a>
		
		<a href="/blog/about">About</a>
		
		<a href="/blog/tags">Tags</a>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Caching Liveviews - Part 2: Publicly caching private Liveviews</h1>
			<div class="meta">Posted on Sep 5, 2024</div>
		</div>
		

		

		<section class="body">
			<p>In <a href="https://svground.fr/blog/posts/caching-liveviews-part-1/">Part 1: The road to HTTP-caching Liveviews</a>, we&rsquo;ve
succeeded in caching the initial rendering of Liveviews.</p>
<p>For this we had to:</p>
<ul>
<li>disable CSRF token check, using a modified version of Phoenix</li>
<li>disable sending the CSRF token when establishing the websocket connection</li>
<li>configure a Plug that sets the <code>cache-control</code> header</li>
<li>and eventually configure <code>PlugHTTPCache</code></li>
</ul>
<p>So far we succeeded in caching Liveviews that render public content. Caching private content with
<code>plug_http_cache</code> or a CDN makes little sense, as the goal of a shared cache is to reuse response
generated for a user A to all other users.</p>
<p>There is an in-between use-case though: how about caching pages that are private, but just
<em>a little</em>?</p>
<p>At first it sounds like nonsense. A page is either private or public. Like a cable,
it can be plugged or unplugged into a computer, not plugged just <em>a little</em>.</p>
<p>Well, take the example website below:</p>
<p><img src="/blog/images/caching_liveviews_authenticated_page.png#center" alt="Sample app with authenticated user"></p>
<p>I guess you now know what I mean: the only private information, specific to the current user, is
the two badges at the top-right of the screen showing the number of articles in the basket, and
notifications for the user.</p>
<p>It&rsquo;s frustrating that we cannot cache this page just because of these 2 badges. Is there a way to
cache at least <em>part</em> of this page?</p>
<h2 id="prior-art">Prior art</h2>
<p>Different strategies are used to deal with caching pages with user content. Let&rsquo;s
explore some of them.</p>
<hr>
<p>Some libraries, such as Drupal&rsquo;s <a href="https://www.drupal.org/project/authcache">Authcache</a>,
alter the cache key depending on user roles and cache a version of the page for each of them.</p>
<p>Think of an online newspaper with anonymous users and subscribed users: the first version of
the page contains only 30% of the article, and the second version, for subscribed users,
contains the full content. In this case we would cache the 2 pages, and return the right one
depending on the user&rsquo;s billing status.</p>
<p>This method is quite similar to what we&rsquo;ve done in
<a href="https://svground.fr/blog/posts/ab-test-with-plug-http-cache/">A/B testing and HTTP caching with <code>plug_http_cache</code></a> and
may or may not use the <code>vary</code> header (this is not important).</p>
<p>It therefore suffers from the same downsides:</p>
<ul>
<li>if you cache at the application level, you cannot cache the page at your CDN</li>
<li>you can configure your CDN as explained in our previous article, at the cost of increased
complexity</li>
<li>storing too many variants of the same page may impact the performance of your cache</li>
<li>but more important, you cannot cache user-specific content like our badges, but only pages by
class of user</li>
</ul>
<hr>
<p>Another method consists in using ESI (Edge-Side Includes) to load user-specific content. Your
template is cached, usually at the edge, and ESI loads the tiny user-specific bits before returning
the page.</p>
<p>The idea is that loading these tiny bits is quicker than loading the full page, and can possibly
be performed in concurrently.</p>
<p><img src="/blog/images/esi_private.png#center" alt="ESI loading private data"></p>
<p>In our example, we would replace the value in the badges by:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">p</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;absolute top-0 right-0 rounded-xl bg-brand text-white font-bold px-1 leading-none&#34;</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">esi:include</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/api/basket/nb_products&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">p</span>&gt;
</span></span></code></pre></div><p>It&rsquo;s similar to loading these private parts with javascript in the browser, except it&rsquo;s done at the
shared cache. Therefore, the first bytes will not be sent before all includes are fetched. By the
way, will not discuss loading private part with javascript, as we use Liveview to avoid the
complexity of developing the backend and frontend separately in the first place.</p>
<p>As a consequence:</p>
<ul>
<li>depending on the performance of your backend, the speed gain might not be so great</li>
<li>you need to develop additional APIs to deal with user-specific content</li>
<li>more complexity at the CDN and on the pages you serve</li>
<li>loss of flexibility: we can&rsquo;t discard the badge if the count is <code>0</code></li>
</ul>
<hr>
<p>When the
<a href="https://www.oncrawl.com/technical-seo/time-to-first-byte-what-and-why-important-part-1/">Time To First Byte</a>
really maters, the previous solution is not satisfactory. A neat solution has been used to speed up
this specific metric and allow caching pages containing user-specific content.</p>
<p><a href="https://bigcommerce.websiteadvantage.com.au/tag-rocket/articles/section-io-bigcommerce/">It</a>
consists in caching the page <em>up to a certain point</em>. You read it well: the first part of the
page is cached and doesn&rsquo;t contain any user data. The second part is not cached, may contain user
data and is sent later.</p>
<p><img src="/blog/images/hole_punching.png#center" alt="Hole punching"></p>
<p>This is particularly interesting because if you cache the <code>&lt;head/&gt;</code> of your HTML: your browser will
immediately read the first lines and start loading the external resources in it (CSS, js…).</p>
<p>If we take our previous sample app and using this method, we could cache the page up to the right
part of the top header which contains user-specific data.</p>
<p>Actually, using CSS tricks (setting reverse order in a flex container for instance), we could put
this top bar at the end of our HTML code and cache most of the page.</p>
<p>Do we really want to do that though?</p>
<h2 id="proposing-a-new-pattern-publicly-cacheable-private-liveviews">Proposing a new pattern: publicly cacheable private Liveviews</h2>
<p>In part 1, we took a look at how Liveview renders the page twice:</p>
<ul>
<li>the first time to render the initial page. This is the page we can cache and we called
it the <em>static mount</em></li>
<li>the second time when the Websocket that enables Liveview&rsquo;s interactivity is established. We called
it the <em>live mount</em></li>
</ul>
<p>This is well documented in
<a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#c:mount/3">Liveview&rsquo;s <code>mount</code> callback documentation</a>:</p>
<blockquote>
<p>For each LiveView in the root of a template, mount/3 is invoked twice: once to do the initial page
load and again to establish the live socket.</p>
</blockquote>
<p>The idea to cache Liveviews with private user content is simple: <strong>render private data only on the
second render</strong> - the <em>live render</em>.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">Static render</th>
          <th></th>
          <th style="text-align: center">Live render</th>
          <th></th>
          <th style="text-align: center">Final render</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center"><img src="/blog/images/shop_static_render.png" alt="Static render"></td>
          <td>➕</td>
          <td style="text-align: center"><img src="/blog/images/shop_live_render.png" alt="Live render"></td>
          <td>🟰</td>
          <td style="text-align: center"><img src="/blog/images/shop_full_render.png" alt="Full render"></td>
      </tr>
      <tr>
          <td style="text-align: center">HTTP</td>
          <td></td>
          <td style="text-align: center">Websocket</td>
          <td></td>
          <td style="text-align: center"></td>
      </tr>
      <tr>
          <td style="text-align: center">Public</td>
          <td></td>
          <td style="text-align: center">Private</td>
          <td></td>
          <td style="text-align: center"></td>
      </tr>
      <tr>
          <td style="text-align: center">Cacheable</td>
          <td></td>
          <td style="text-align: center">Non-cacheable</td>
          <td></td>
          <td style="text-align: center"></td>
      </tr>
  </tbody>
</table>
<p>First, let&rsquo;s admit that this visual description is not 100% accurate, since the <em>live render</em>
renders the full page again, and therefore loads the same data (here the product list). This depicts
the part of the page that actually changes.</p>
<p>Second, this approach is not suited for heavy user-centric pages. This can also pose problems when
the page contains forms and CSRF tokens, although Liveviews handle forms differently (and without
CSRF tokens).</p>
<p>Otherwise, for all the pages with little user content, such as badges, username, unread threads on
a forum… I believe this approach remains sane to have mainly public-content pages cached.</p>
<p>Let&rsquo;s try a naive implementation to this pattern in an example project called
<a href="https://github.com/tanguilp/cacheable_liveviews/tree/3ceb0aef65f6794c4f20dbaffe1ccb9bd32b6da6"><code>cacheable_liveviews</code></a>
and see how it looks on the screen. The core code consists in loading user data only on the <em>live
mount</em>:</p>
<p><code>lib/cacheable_liveviews_web/live/main_live/index.ex</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span><span style="color:#66d9ef">defmodule</span> <span style="color:#a6e22e">CacheableLiveviewsWeb.MainLive.Index</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@impl</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> mount(_params, session, socket) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    socket <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      socket
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign(<span style="color:#e6db74">:top_products</span>, <span style="color:#a6e22e">Product</span><span style="color:#f92672">.</span>top())
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign(<span style="color:#e6db74">:nb_items_in_cart</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign(<span style="color:#e6db74">:nb_notifications</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign(<span style="color:#e6db74">:user_id</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> connected?(socket) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      socket
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign(<span style="color:#e6db74">:staticmount</span>, <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> static_mount()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      socket
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign(<span style="color:#e6db74">:staticmount</span>, <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> live_mount(session)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> static_mount(socket) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Nothing to do</span>
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">:ok</span>, socket}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> live_mount(socket, session) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> authenticated?(session) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      live_mount_authenticated(socket, session)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      live_mount_anonymous(socket)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> live_mount_authenticated(socket, session) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># User is logged in</span>
</span></span><span style="display:flex;"><span>    user_id <span style="color:#f92672">=</span> session[<span style="color:#e6db74">&#34;user_id&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    socket <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      socket
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign(<span style="color:#e6db74">:user_id</span>, user_id)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign(<span style="color:#e6db74">:nb_items_in_cart</span>, <span style="color:#a6e22e">User</span><span style="color:#f92672">.</span>items_in_cart(user_id) <span style="color:#f92672">|&gt;</span> length())
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign(<span style="color:#e6db74">:nb_notifications</span>, <span style="color:#a6e22e">User</span><span style="color:#f92672">.</span>list_notifications(user_id) <span style="color:#f92672">|&gt;</span> length())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">:ok</span>, socket}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> live_mount_anonymous(socket) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Nothing to do, user is logged out</span>
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">:ok</span>, socket}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#...</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>We use Liveview&rsquo;s
<a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#connected?/1"><code>connected?</code></a> function
to figure out which render we are currently performing.</p>
<p>We then initialize a few variables that will receive a value on the <em>live mount</em> if the user is
authenticated, along with some other variables to figure out in the code if the render is static
or live, and the user authenticated or not.</p>
<p>Then we can use it in our template to conditionnaly render private part of the page when the user is
authenticated:</p>
<p><code>lib/cacheable_liveviews_web/components/layouts/app.html.heex</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-eex" data-lang="eex"><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>div <span style="color:#e6db74">:if</span><span style="color:#f92672">=</span>{<span style="color:#f92672">not</span> <span style="color:#a6e22e">@staticmount</span>} class<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;absolute right-1 top-1 flex&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;!--</span> ... <span style="color:#f92672">--&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>div<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;.</span>link href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/login&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Heroicons</span><span style="color:#f92672">.</span>user <span style="color:#e6db74">:if</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">@user_id</span>} class<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;w-8 h-8 text-gray-500&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Heroicons</span><span style="color:#f92672">.</span>arrow_right_end_on_rectangle <span style="color:#e6db74">:if</span><span style="color:#f92672">=</span>{<span style="color:#f92672">!</span><span style="color:#a6e22e">@user_id</span>} class<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;w-8 h-8 text-gray-500&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;/.</span>link<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;</span>p
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">:if</span><span style="color:#f92672">=</span>{is_integer(<span style="color:#a6e22e">@nb_notifications</span>) <span style="color:#f92672">and</span> <span style="color:#a6e22e">@nb_notifications</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>}
</span></span><span style="display:flex;"><span>        class<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;absolute top-0 right-0 rounded-xl bg-brand text-white font-bold px-1 leading-none&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">%</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">@nb_notifications</span> <span style="color:#960050;background-color:#1e0010">%</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;/</span>p<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/</span>div<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/</span>div<span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>First we render this part of the page only on the <em>live mount</em>. It&rsquo;s not needed for SEO, and
rendering some default icons could provoke blips when the <em>live mount</em> update this part with other
icons (unless they&rsquo;re exactly aligned pixel-wise).</p>
<p>Then, we render a different icon depending on whether the user is authenticated or not. In a
real-world example, we&rsquo;d have different links, but keep in mind this is just a demo.</p>
<p>Finally, we render the notification if they are some.</p>
<p>Let&rsquo;s log in:</p>
<p><img src="/blog/images/full_render_video.gif#center" alt="Full render"></p>
<p>On localhost, everything renders instantly. Let&rsquo;s simulate slower network with the browser&rsquo;s tools:</p>
<p><img src="/blog/images/full_render_video_slow.gif#center" alt="Slowed down full render"></p>
<p>It emphasizes the importance, when using this method, of correctly building your pages so as to
avoid having live elements appearing later moving other parts of the page: make sure they have the
sufficient place left blank in the static rendering.</p>
<h2 id="refining-the-implementation">Refining the implementation</h2>
<p>The greatest danger when caching Liveviews with user content is to make a mistake and include some
private content during the <em>static render</em>. Then it will be cached and served to other users.</p>
<p>You might have noticed we asynchronously load the total number of products. We simulate a heavy
operation that we don&rsquo;t want to slow down the rendering of the overall page.</p>
<p>To do this, we use the
<a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#assign_async/3"><code>Phoenix.LiveView.assign_async/3</code></a>
function that was released in LiveView 0.20. In our LiveView we added:</p>
<p><code>cacheable_liveviews/lib/cacheable_liveviews_web/live/main_live/index.ex</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span>  <span style="color:#a6e22e">@impl</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> mount(_params, session, socket) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    socket <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      socket
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> [...]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign_async(<span style="color:#e6db74">:nb_total_products</span>, <span style="color:#f92672">&amp;</span>get_nb_total_products<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    [...]
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [...]
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> get_nb_total_products(), <span style="color:#e6db74">do</span>: {<span style="color:#e6db74">:ok</span>, %{<span style="color:#e6db74">nb_total_products</span>: <span style="color:#a6e22e">Product</span><span style="color:#f92672">.</span>count_products()}}
</span></span></code></pre></div><p>As the documentation state:</p>
<blockquote>
<p>The task is only started when the socket is connected.</p>
</blockquote>
<p>This is pretty much what we want to do for our private assigns, as well as checking the user is
authenticated.</p>
<p>Let&rsquo;s create a helper function similar to <code>assign_async/3</code>:</p>
<p><code>cacheable_liveviews/lib/cacheable_liveviews_web/live_helpers.ex</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span><span style="color:#66d9ef">defmodule</span> <span style="color:#a6e22e">CacheableLiveviewsWeb.LiveHelpers</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">import</span> <span style="color:#a6e22e">Phoenix.LiveView</span>, <span style="color:#e6db74">only</span>: [<span style="color:#e6db74">connected?</span>: <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">import</span> <span style="color:#a6e22e">Phoenix.Component</span>, <span style="color:#e6db74">only</span>: [<span style="color:#e6db74">assign</span>: <span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@user_session_key</span> <span style="color:#e6db74">&#34;user_id&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> assign_private(socket, session, key, fun) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> connected?(socket) <span style="color:#f92672">and</span> is_map_key(session, <span style="color:#a6e22e">@user_session_key</span>) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      assign(socket, key, fun<span style="color:#f92672">.</span>(session[<span style="color:#a6e22e">@user_session_key</span>]))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      assign(socket, key, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>Then we import it to all our Liveviews:</p>
<p><code>cacheable_liveviews/lib/cacheable_liveviews_web.ex</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> live_view <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">quote</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">use</span> <span style="color:#a6e22e">Phoenix.LiveView</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">layout</span>: {<span style="color:#a6e22e">CacheableLiveviewsWeb.Layouts</span>, <span style="color:#e6db74">:app</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># We add this line</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">import</span> <span style="color:#a6e22e">CacheableLiveviewsWeb.LiveHelpers</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">unquote</span>(html_helpers())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>Assigns are initialized to <code>nil</code> for static rendering or when the user is unauthenticated, but you
might need to set another value if <code>nil</code> is a meaningful value in your case. We can now use this
helper yo simplify this new pattern and make it safer:</p>
<p><code>cacheable_liveviews/lib/cacheable_liveviews_web/live/main_live/index.ex</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span><span style="color:#66d9ef">defmodule</span> <span style="color:#a6e22e">CacheableLiveviewsWeb.MainLive.Index</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># [...]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> mount(_params, session, socket) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    socket <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      socket
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign(<span style="color:#e6db74">:top_products</span>, <span style="color:#a6e22e">Product</span><span style="color:#f92672">.</span>top())
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign(<span style="color:#e6db74">:connected?</span>, connected?(socket))
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign(<span style="color:#e6db74">:authenticated?</span>, is_map_key(session, <span style="color:#a6e22e">@user_session_key</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign_private(session, <span style="color:#e6db74">:nb_items_in_cart</span>, <span style="color:#f92672">&amp;</span>get_nb_items_in_cart<span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign_private(session, <span style="color:#e6db74">:nb_notifications</span>, <span style="color:#f92672">&amp;</span>get_nb_notifications<span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> assign_async(<span style="color:#e6db74">:nb_total_products</span>, <span style="color:#f92672">&amp;</span>get_nb_total_products<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> connected?(socket) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      static_mount(socket)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      live_mount(socket)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> static_mount(socket) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Nothing more to do</span>
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">:ok</span>, socket}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> live_mount(socket) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Set up additional live features. For instance we could subscribe to</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># price updates through a Phoenix channel</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">:ok</span>, socket}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@impl</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> handle_info(evt, socket) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Handle live updates of the page, e.g. price updates</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">:noreply</span>, socket}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> get_nb_items_in_cart(user_id), <span style="color:#e6db74">do</span>: user_id <span style="color:#f92672">|&gt;</span> <span style="color:#a6e22e">User</span><span style="color:#f92672">.</span>items_in_cart() <span style="color:#f92672">|&gt;</span> length()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> get_nb_notifications(user_id), <span style="color:#e6db74">do</span>: user_id <span style="color:#f92672">|&gt;</span> <span style="color:#a6e22e">User</span><span style="color:#f92672">.</span>list_notifications() <span style="color:#f92672">|&gt;</span> length()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> get_nb_total_products(), <span style="color:#e6db74">do</span>: {<span style="color:#e6db74">:ok</span>, %{<span style="color:#e6db74">nb_total_products</span>: <span style="color:#a6e22e">Product</span><span style="color:#f92672">.</span>count_products()}}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>If you stick to the rule of using the <code>session</code> variable only as an argument to
<code>assign_private/4</code>, then you should be safe.</p>
<h2 id="additional-notes">Additional notes</h2>
<p>This method doesn&rsquo;t only work with Elixir&rsquo;s <code>plug_http_cache</code> library, but with any compliant
HTTP cache. You could even use both, <code>plug_http_cache</code> couple with a CDN, and have 2 levels of
caching.</p>
<p>A few last things need to be considered:</p>
<ul>
<li>when using <a href="https://hexdocs.pm/phoenix_live_view/live-navigation.html">live navigation</a>, only the
first visited page is returned as HTTP. All other pages are sent over Liveview&rsquo;s websocket, and
therefore the HTTP cache will not been used</li>
<li>as a consequence and as explained in part 1, and especially if you want to cache pages for the sake
of SEO, you might want to warm up your cache after deployment by visiting these pages, either using
external scripts or using some
<a href="https://elixirforum.com/t/invoke-phoenix-endpoint-programmatically-at-runtime/26402">tricks</a>
to visit (and cache) them programmatically from your app</li>
<li>speaking of deployment, you might need to invalidate your modified Liveviews after deploying new
versions if you use <a href="https://github.com/tanguilp/plug_http_cache"><code>plug_http_cache</code></a>. You can use
<a href="https://hexdocs.pm/http_cache/http_cache.html#invalidate_url/2"><code>http_cache:invalidate_url/2</code></a>
to that end. Since Liveview rerenders the full content on <em>live mount</em>, the page will eventually
be displayed as expected even if the cache version differs, but the page layout will change between
the <em>static</em> and <em>live mounts</em> as shown in the following capture:</li>
</ul>
<p><img src="/blog/images/render_stale.gif#center" alt="Rendering stale page"></p>
<ul>
<li><a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.Router.html#live_session/3"><code>live_session/3</code></a>
accepts a <code>:session</code> parameter to add some values to the user session. These values are stored in the
(static) HTML page. Therefore, do not use it to store user content when caching is enabled</li>
</ul>
<h2 id="wrapping--it-up">Wrapping  it up</h2>
<p>By rendering private user-data only on <em>live mount</em>, we can enable caching the public part of a
page containing user data using regular HTTP caching mechanisms.</p>
<p>This method works within Phoenix (using the <code>plug_http_cache</code> library)
or with any shared cache between your Phoenix app and the user&rsquo;s browser.</p>
<p>Extra care must be taken to not inadvertently leak private user-data. I believe one can mitigate this
risk by implementing well-thought helpers inspired by <code>async_assign</code>.</p>
<p>The demo application used for the screenshots of this post is published on github and is called
<a href="https://github.com/tanguilp/cacheable_liveviews"><code>cacheable_liveviews</code></a>.</p>
<p>Happy hacking!</p>

		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/http-caching">HTTP caching</a></li>
					
					<li><a href="/tags/elixir">Elixir</a></li>
					
					<li><a href="/tags/liveview">Liveview</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/tanguilp/" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://www.linkedin.com/in/tanguil/" rel="me" title="Linkedin"><i data-feather="linkedin"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
  feather.replace()
</script></div>
    </body>
</html>
