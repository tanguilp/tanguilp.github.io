<!DOCTYPE html>
<html><head lang="en"><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blog/livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Introducing http_cache, a BEAM-native standard-compliant HTTP caching library - Tangui&#39;s blog</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="One year ago I released the http_cache Erlang library
along with 2 Elixir libraries (plug_http_cache
and tesla_http_cache) that make use of it.
When I started writing these libs, I thought it would take a few weeks of work to have them
completed. HTTP caching is harder than I though, and it took way longer. Why, then, bothering writing
them when other HTTP caching systems already exist? In this blog post, I intend to explain my
motivation and show what features they support." />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="http://localhost:1313/blog/posts/introducing-http-cache/">
  <meta property="og:site_name" content="Tangui&#39;s blog">
  <meta property="og:title" content="Introducing http_cache, a BEAM-native standard-compliant HTTP caching library">
  <meta property="og:description" content="One year ago I released the http_cache Erlang library along with 2 Elixir libraries (plug_http_cache and tesla_http_cache) that make use of it.
When I started writing these libs, I thought it would take a few weeks of work to have them completed. HTTP caching is harder than I though, and it took way longer. Why, then, bothering writing them when other HTTP caching systems already exist? In this blog post, I intend to explain my motivation and show what features they support.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-10-04T12:35:32+02:00">
    <meta property="article:modified_time" content="2023-10-04T12:35:32+02:00">
    <meta property="article:tag" content="HTTP Caching">
    <meta property="article:tag" content="Elixir">
    <meta property="article:tag" content="Erlang">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Introducing http_cache, a BEAM-native standard-compliant HTTP caching library">
  <meta name="twitter:description" content="One year ago I released the http_cache Erlang library along with 2 Elixir libraries (plug_http_cache and tesla_http_cache) that make use of it.
When I started writing these libs, I thought it would take a few weeks of work to have them completed. HTTP caching is harder than I though, and it took way longer. Why, then, bothering writing them when other HTTP caching systems already exist? In this blog post, I intend to explain my motivation and show what features they support.">
<script src="http://localhost:1313/blog/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/blog/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/blog/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />

	
	

	
	

	
		
		
		<link rel="stylesheet" type="text/css" href="http://localhost:1313/blog/css/custom.d287809400cafea254e83ff2007e8eae4bcba882165ffd064d74d2483d34b156.css">
		
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">Tangui&#39;s blog</a>
	</div>
	<nav>
		
		<a href="/blog/">Home</a>
		
		<a href="/blog/posts">All posts</a>
		
		<a href="/blog/about">About</a>
		
		<a href="/blog/tags">Tags</a>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Introducing http_cache, a BEAM-native standard-compliant HTTP caching library</h1>
			<div class="meta">Posted on Oct 4, 2023</div>
		</div>
		

		

		<section class="body">
			<p>One year ago I released the <a href="https://github.com/tanguilp/http_cache"><code>http_cache</code></a> Erlang library
along with 2 Elixir libraries (<a href="https://github.com/tanguilp/plug_http_cache"><code>plug_http_cache</code></a>
and <a href="https://github.com/tanguilp/tesla_http_cache"><code>tesla_http_cache</code></a>) that make use of it.</p>
<p>When I started writing these libs, I thought it would take a few weeks of work to have them
completed. HTTP caching is harder than I though, and it took way longer. Why, then, bothering writing
them when other HTTP caching systems already exist? In this blog post, I intend to explain my
motivation and show what features they support.</p>
<h2 id="prior-experience-with-http-caching">Prior experience with HTTP caching</h2>
<p>At a company where I worked a few years ago, I was tasked with migrating our HTTP caching system
from a CDN to an in-house system. CDN costs were skyrocketing due to increased use of our service
and abuses from some users or scrapers. Our users were closed to our datacenters, so the latency
increase hit was expected to be reasonable.</p>
<p>We discussed 2 options: write an Erlang HTTP caching proxy, or use an existing software. We went
with the latter, because why reinventing the wheel after all, and chose to deploy Varnish, a
well-known HTTP cache server.</p>
<p>For those who have already deployed Varnish and don&rsquo;t want to feel the pain again, feel free to skip
this section. Deploying it turned to be more cumbersome than we thought.</p>
<p>With Varnish, you first have to master a brand new language: VCL. This is Varnish DSL to configure
which objects are cached, and for how long (among other things). To give you a taste, here&rsquo;s an
example of a VCL configuration file:</p>
<pre tabindex="0"><code class="language-vcl" data-lang="vcl">sub vcl_recv {
    set req.http.Host = regsub(req.http.Host, &#34;:[0-9]+&#34;, &#34;&#34;);
    unset req.http.proxy;
    set req.url = std.querysort(req.url);
    set req.url = regsub(req.url, &#34;\?$&#34;, &#34;&#34;);
    set req.http.Surrogate-Capability = &#34;key=ESI/1.0&#34;;

    if (std.healthy(req.backend_hint)) {
        set req.grace = 10s;
    }

    if (!req.http.X-Forwarded-Proto) {
        if(std.port(server.ip) == 443 || std.port(server.ip) == 8443) {
            set req.http.X-Forwarded-Proto = &#34;https&#34;;
        } else {
            set req.http.X-Forwarded-Proto = &#34;https&#34;;
        }
    }

    if (req.http.Upgrade ~ &#34;(?i)websocket&#34;) {
        return (pipe);
    }

    if (req.method != &#34;GET&#34; &amp;&amp;
        req.method != &#34;HEAD&#34; &amp;&amp;
        req.method != &#34;PUT&#34; &amp;&amp;
        req.method != &#34;POST&#34; &amp;&amp;
        req.method != &#34;TRACE&#34; &amp;&amp;
        req.method != &#34;OPTIONS&#34; &amp;&amp;
        req.method != &#34;PATCH&#34; &amp;&amp;
        req.method != &#34;DELETE&#34;) {
        return (pipe);
    }

    if (req.method != &#34;GET&#34; &amp;&amp; req.method != &#34;HEAD&#34;) {
        return (pass);
    }

    if (req.url ~ &#34;^[^?]*\.(7z|avi|bmp|bz2|css|csv|doc|docx|eot|flac|flv|gif|gz|ico|jpeg|jpg|js|less|mka|mkv|mov|mp3|mp4|mpeg|mpg|odt|ogg|ogm|opus|otf|pdf|png|ppt|pptx|rar|rtf|svg|svgz|swf|tar|tbz|tgz|ttf|txt|txz|wav|webm|webp|woff|woff2|xls|xlsx|xml|xz|zip)(\?.*)?$&#34;) {
        unset req.http.Cookie;
        return(hash);
    }
}

sub vcl_hash {
    hash_data(req.http.X-Forwarded-Proto);
}

sub vcl_backend_response {
    if (bereq.url ~ &#34;^[^?]*\.(7z|avi|bmp|bz2|css|csv|doc|docx|eot|flac|flv|gif|gz|ico|jpeg|jpg|js|less|mka|mkv|mov|mp3|mp4|mpeg|mpg|odt|ogg|ogm|opus|otf|pdf|png|ppt|pptx|rar|rtf|svg|svgz|swf|tar|tbz|tgz|ttf|txt|txz|wav|webm|webp|woff|woff2|xls|xlsx|xml|xz|zip)(\?.*)?$&#34;) {
        unset beresp.http.Set-Cookie;
        set beresp.ttl = 1d;
    }

    if (beresp.http.Surrogate-Control ~ &#34;ESI/1.0&#34;) {
        unset beresp.http.Surrogate-Control;
        set beresp.do_esi = true;
    }

    set beresp.grace = 6h;
}
</code></pre><p>The language itself is pretty accessible. You might have noticed some top-level function
(<code>vcl_recv</code>, <code>vcl_hash</code>, <code>vcl_backend_response</code>): these are states of Varnish FSM that are called at
specific steps of the request/response processing.
When writing VCL code, you must understand what theses steps do as shown in the FSM schema:</p>
<p><img src="/blog/images/varnish-finite-state-machine.svg#center" alt="VCL FSM"></p>
<p>Like any language,  VCL comes with its quirks. For instance, some headers can appear multiple times
in an HTTP request or response. Both following examples are valid and equivalent:</p>
<pre tabindex="0"><code>Accept: text/html, application/xhtml+xml
</code></pre><pre tabindex="0"><code>Accept: text/html
Accept: application/xhtml+xml
</code></pre><p>However, VCL returns only the value of the first occurrence of the header. It&rsquo;s possible to get all
values by using the
<a href="https://docs.varnish-software.com/varnish-enterprise/vmods/header/"><code>header</code> VMOD</a> (an extension),
either by finding the library compiled for the right OS <strong>and</strong> ABI, or by compiling it from
source.</p>
<p>For performance reasons, we wanted to optimize requesting many resources to use the cache. When
hitting:</p>
<p><code>/resources/1</code></p>
<p>and then:</p>
<p><code>/resources?id=1,2,3</code></p>
<p>we wanted to be able to:</p>
<ul>
<li>use the cached version of <code>/resources/1</code></li>
<li>retrieve <code>/resources/2</code> and <code>/resources/3</code> from the origin (backend) and cache them</li>
</ul>
<p>Varnish supports <a href="https://en.wikipedia.org/wiki/Edge_Side_Includes">ESI</a>, that allows dynamically
including chunks of data coming from the cache. This makes access to the cache programmable. This
looked promising, but for some reasons (limitations with error handling mainly), we couldn&rsquo;t use it
as we expected. Long story short, we ended up deploying 2 types of Varnish instances:</p>
<ul>
<li>one to cache requests to unique resources</li>
<li>one to cache requests to a batch of resources</li>
</ul>
<p>We also had to deploy Nginx servers:</p>
<ul>
<li>for TLS termination (Varnish OSS doesn&rsquo;t support it)</li>
<li>to implement the optimization mentioned above, using Lua scripts</li>
</ul>
<p>Suddenly that was a lot of services!</p>
<p>We also needed to support invalidation. Varnish supports it by setting a key in a header before
caching a response (<code>xkey</code>) and hitting a specific URL (<code>/purge</code>) to delete matching responses. It
allows for instance to delete all images of a given client and force cache to repopulate with
updated images.</p>
<p>It supports it, but our infrastructure didn&rsquo;t. We had deployed our caching
service using docker swarm and our 3 Varnish instance were &ldquo;hidden&rdquo; behind a unique IP address. This
is the standard way to do load-balancing with docker swarm.</p>
<p>As a consequence, an invalidation request would only hit one instance of Varnish, and invalidates
cached responses on this instance. Varnish instances do not communicate with each other, and thus do
not broadcast invalidation requests. To solve this issue we had to</p>
<ul>
<li>change the docker swarm load-balancing configuration (from <code>vip</code> to <code>dnsrr</code>)</li>
<li>write a Lua script (again) on our nginx instance that:
<ul>
<li>intercepts purge requests</li>
<li>requests the DNS to get the address of all Varnish instances</li>
<li>duplicates and forwards the invalidation request to them</li>
</ul>
</li>
</ul>
<p>Last but not least, after a few months of running all of it in production, we noticed a strange
behaviour with our 40 workers downstream of varnish. Their workload were very uneven,
and after investigating we noticed it was directly correlated to the number of connections opened
by Varnish to these workers. Some had 2 or 3 more opened connections from Varnish than the others.</p>
<p>We noticed it was also correlated with the <strong>order</strong> these worker were deployed using rolling
upgrades: the first deployed workers had many more connections, and the lasts way less.</p>
<p>We finally understood that this is due to the nature of Varnish load-balancing and persistent
connection: when workers are restarted, Varnish opens new persistent connections using a simple round
robin algorithm, and the first deployed workers will naturally have received more connections at the
end of the process. Surprisingly, this imbalance <em>persists</em> a long time.</p>
<p><img src="data:image/png;base64,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#center" alt="Connection imbalance with load-balancing and persistent connections"></p>
<p>To know more about this class of issue I&rsquo;d recommend the following article:
<a href="https://www.ateam-oracle.com/post/long-lived-tcp-connections-and-load-balancers">Long-lived TCP connections and Load Balancers</a>.</p>
<p>These are some of the challenges you may meet deploying such a piece of software. My point is not to
rant about Varnish. It&rsquo;s a very performant piece of software, optimized in subtle ways, and it&rsquo;s OSS.
We successfully deployed it after a few weeks of work and since then it serves cached content for
thousands of requests per second, with high reliability. We save thousands of $ every month in CDN
bills. For this, thanks for your service, Varnish 🫡</p>
<p>But setting up and maintaining additional software comes with a cost, and I just discovered that
(it was my first job as a software engineer).</p>
<h2 id="project-genesis">Project genesis</h2>
<p>Some time later, I was watching
<a href="https://www.youtube.com/watch?v=JvBT4XBdoUE">The Soul of Erlang and Elixir</a>. Remember this slide?</p>
<p><img src="/blog/images/sasa_slide.png#center" alt="Soul of Erlang slide"></p>
<p>The BEAM being excellent at managing state, among other things, I started thinking we needed an
BEAM alternative. Something like that:</p>
<p><img src="/blog/images/sasa_slide_edited.png#center" alt="Soul of Erlang slide - with HTTP caching"></p>
<p><code>http_cache</code> was in its infancy.</p>
<p>HTTP caching is standardized in <a href="https://www.rfc-editor.org/rfc/rfc9111.html">RFC9111</a> (supersedes
<a href="https://datatracker.ietf.org/doc/html/rfc7234">RFC7234</a>).
If you want to taste how complex HTTP caching is, you can read
<a href="https://www.rfc-editor.org/rfc/rfc9111.html#section-3">Section 3</a>.</p>
<p>The main difficulty, when caching HTTP responses, is that a request can have several associated
responses. It all depends on the request headers, and this is why the
<a href="https://www.fastly.com/blog/best-practices-using-vary-header"><code>vary</code></a> header exists.</p>
<p>From an implementation perspective, it means that returning a cached response involves:</p>
<ul>
<li>retrieving the <em>list</em> of eligible cached response for a given request</li>
<li>comparing the current request with the request that triggered caching a response in the first
place, to check if headers that <em>vary</em> match</li>
</ul>
<p>Other than that, there are less-known requirements such as:</p>
<ul>
<li>deleting the associated cached responses when a destructive method is called on a resource.
<code>PATCH /resources/1</code> should invalidate cached responses for <code>/resources/1</code></li>
<li>when revalidating (asking the origin server if the response changed), headers of the stored
responses must be updated in case a <code>304 Not Modified</code> response is received</li>
<li>the same mechanism applies for <code>HEAD</code> requests</li>
</ul>
<p>Hence the storage backend for cached response cannot be a plain key/value store.</p>
<p>Now let&rsquo;s see how HTTP caching was implemented in this libraries.</p>
<h2 id="http_cache-basics"><code>http_cache</code> basics</h2>
<p><a href="https://github.com/tanguilp/http_cache"><code>http_cache</code></a> is a stateless Erlang library. It analyzes
request when caching with
<a href="https://hexdocs.pm/http_cache/http_cache.html#cache/3"><code>http_cache:cache/3</code></a>, to determine if
they can be cached and for how long, and returns the freshest compatible response when using
<a href="https://hexdocs.pm/http_cache/http_cache.html#get/2"><code>http_cache:get/2</code></a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span> Req <span style="color:#f92672">=</span> {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">&gt;&gt;</span>, <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;http://example.org&#34;</span><span style="color:#f92672">&gt;&gt;</span>, [], <span style="color:#f92672">&lt;&lt;&gt;&gt;</span>}.
</span></span><span style="display:flex;"><span>{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;http://example.org&#34;</span><span style="color:#f92672">&gt;&gt;</span>,[],<span style="color:#f92672">&lt;&lt;&gt;&gt;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span><span style="color:#f92672">&gt;</span> Resp <span style="color:#f92672">=</span> {<span style="color:#ae81ff">200</span>, [{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-type&#34;</span><span style="color:#f92672">&gt;&gt;</span>, <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;text/plain&#34;</span><span style="color:#f92672">&gt;&gt;</span>}], <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;Cache me&#34;</span><span style="color:#f92672">&gt;&gt;</span>}.
</span></span><span style="display:flex;"><span>{<span style="color:#ae81ff">200</span>,[{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-type&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;text/plain&#34;</span><span style="color:#f92672">&gt;&gt;</span>}],<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;Cache me&#34;</span><span style="color:#f92672">&gt;&gt;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span><span style="color:#f92672">&gt;</span> Opts <span style="color:#f92672">=</span> #{store <span style="color:#f92672">=&gt;</span> http_cache_store_process, type <span style="color:#f92672">=&gt;</span> shared}.
</span></span><span style="display:flex;"><span>#{store <span style="color:#f92672">=&gt;</span> http_cache_store_process, type <span style="color:#f92672">=&gt;</span> shared}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span> http_cache:<span style="color:#a6e22e">cache</span>(Req, Resp, Opts).
</span></span><span style="display:flex;"><span>{ok,{<span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>     [{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-type&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;text/plain&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>      {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-length&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;8&#34;</span><span style="color:#f92672">&gt;&gt;</span>}],
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;Cache me&#34;</span><span style="color:#f92672">&gt;&gt;</span>}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span><span style="color:#f92672">&gt;</span> http_cache:get(Req, Opts).
</span></span><span style="display:flex;"><span>{fresh,{{ <span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">21</span>,<span style="color:#ae81ff">255</span>,<span style="color:#ae81ff">141</span>,<span style="color:#ae81ff">93</span>,<span style="color:#ae81ff">218</span>,<span style="color:#ae81ff">86</span>,<span style="color:#ae81ff">217</span>,<span style="color:#ae81ff">58</span>,<span style="color:#ae81ff">55</span>,<span style="color:#ae81ff">246</span>,<span style="color:#ae81ff">85</span>,<span style="color:#ae81ff">151</span>,<span style="color:#ae81ff">223</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">133</span>,<span style="color:#ae81ff">134</span>,<span style="color:#ae81ff">248</span>,<span style="color:#ae81ff">212</span>,<span style="color:#ae81ff">121</span>,<span style="color:#ae81ff">102</span>,<span style="color:#ae81ff">151</span>,<span style="color:#ae81ff">176</span>,<span style="color:#ae81ff">244</span>,<span style="color:#ae81ff">210</span>,<span style="color:#ae81ff">11</span>,<span style="color:#ae81ff">46</span>,
</span></span><span style="display:flex;"><span>           ...<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>         #{}},
</span></span><span style="display:flex;"><span>        {<span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>         [{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-type&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;text/plain&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>          {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-length&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;8&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>          {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;age&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;10&#34;</span><span style="color:#f92672">&gt;&gt;</span>}],
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;Cache me&#34;</span><span style="color:#f92672">&gt;&gt;</span>}}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">% after some time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">6</span><span style="color:#f92672">&gt;</span> http_cache:get(Req, Opts).
</span></span><span style="display:flex;"><span>{must_revalidate,{{ <span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">21</span>,<span style="color:#ae81ff">255</span>,<span style="color:#ae81ff">141</span>,<span style="color:#ae81ff">93</span>,<span style="color:#ae81ff">218</span>,<span style="color:#ae81ff">86</span>,<span style="color:#ae81ff">217</span>,<span style="color:#ae81ff">58</span>,<span style="color:#ae81ff">55</span>,<span style="color:#ae81ff">246</span>,
</span></span><span style="display:flex;"><span>                     <span style="color:#ae81ff">85</span>,<span style="color:#ae81ff">151</span>,<span style="color:#ae81ff">223</span>,<span style="color:#ae81ff">133</span>,<span style="color:#ae81ff">134</span>,<span style="color:#ae81ff">248</span>,<span style="color:#ae81ff">212</span>,<span style="color:#ae81ff">121</span>,<span style="color:#ae81ff">102</span>,
</span></span><span style="display:flex;"><span>                     <span style="color:#ae81ff">151</span>,<span style="color:#ae81ff">176</span>,<span style="color:#ae81ff">244</span>,<span style="color:#ae81ff">210</span>,<span style="color:#ae81ff">11</span>,<span style="color:#ae81ff">46</span>,...<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>                   #{}},
</span></span><span style="display:flex;"><span>                  {<span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>                   [{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-type&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;text/plain&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>                    {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-length&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;8&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>                    {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;age&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;218&#34;</span><span style="color:#f92672">&gt;&gt;</span>}],
</span></span><span style="display:flex;"><span>                   <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;Cache me&#34;</span><span style="color:#f92672">&gt;&gt;</span>}}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">% after more time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">7</span><span style="color:#f92672">&gt;</span> http_cache:get(Req, Opts).
</span></span><span style="display:flex;"><span>miss
</span></span></code></pre></div><p>To save space when storing responses, it can automatically compress and decompress content with
gzip, when using the
<a href="">right options</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span> Req <span style="color:#f92672">=</span> {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">&gt;&gt;</span>, <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;http://example.org&#34;</span><span style="color:#f92672">&gt;&gt;</span>, [{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;accept-encoding&#34;</span><span style="color:#f92672">&gt;&gt;</span>, <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;gzip&#34;</span><span style="color:#f92672">&gt;&gt;</span>}], <span style="color:#f92672">&lt;&lt;&gt;&gt;</span>}.
</span></span><span style="display:flex;"><span>{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;http://example.org&#34;</span><span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span> [{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;accept-encoding&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;gzip&#34;</span><span style="color:#f92672">&gt;&gt;</span>}],
</span></span><span style="display:flex;"><span> <span style="color:#f92672">&lt;&lt;&gt;&gt;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span><span style="color:#f92672">&gt;</span> Resp <span style="color:#f92672">=</span> {<span style="color:#ae81ff">200</span>, [{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-type&#34;</span><span style="color:#f92672">&gt;&gt;</span>, <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;text/plain&#34;</span><span style="color:#f92672">&gt;&gt;</span>}], <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;Cache me&#34;</span><span style="color:#f92672">&gt;&gt;</span>}.
</span></span><span style="display:flex;"><span>{<span style="color:#ae81ff">200</span>,[{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-type&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;text/plain&#34;</span><span style="color:#f92672">&gt;&gt;</span>}],<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;Cache me&#34;</span><span style="color:#f92672">&gt;&gt;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span><span style="color:#f92672">&gt;</span> Opts <span style="color:#f92672">=</span> #{store <span style="color:#f92672">=&gt;</span> http_cache_store_process, auto_compress <span style="color:#f92672">=&gt;</span> true, auto_accept_encoding <span style="color:#f92672">=&gt;</span> true, compression_threshold <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0</span>}.
</span></span><span style="display:flex;"><span>#{auto_accept_encoding <span style="color:#f92672">=&gt;</span> true,auto_compress <span style="color:#f92672">=&gt;</span> true,
</span></span><span style="display:flex;"><span>  compression_threshold <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>  store <span style="color:#f92672">=&gt;</span> http_cache_store_process}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span> http_cache:<span style="color:#a6e22e">cache</span>(Req, Resp, Opts).
</span></span><span style="display:flex;"><span>{ok,{<span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>     [{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-type&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;text/plain&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>      {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;vary&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;accept-encoding&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>      {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-encoding&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;gzip&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>      {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-length&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;28&#34;</span><span style="color:#f92672">&gt;&gt;</span>}],
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">31</span>,<span style="color:#ae81ff">139</span>,<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">115</span>,<span style="color:#ae81ff">78</span>,<span style="color:#ae81ff">76</span>,<span style="color:#ae81ff">206</span>,<span style="color:#ae81ff">72</span>,<span style="color:#ae81ff">85</span>,<span style="color:#ae81ff">200</span>,<span style="color:#ae81ff">77</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">162</span>,<span style="color:#ae81ff">221</span>,<span style="color:#ae81ff">237</span>,<span style="color:#ae81ff">17</span>,...<span style="color:#f92672">&gt;&gt;</span>}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span><span style="color:#f92672">&gt;</span> http_cache:get(Req, Opts).
</span></span><span style="display:flex;"><span>{fresh,{{ <span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">66</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">235</span>,<span style="color:#ae81ff">59</span>,<span style="color:#ae81ff">78</span>,<span style="color:#ae81ff">212</span>,<span style="color:#ae81ff">170</span>,<span style="color:#ae81ff">99</span>,<span style="color:#ae81ff">22</span>,<span style="color:#ae81ff">66</span>,<span style="color:#ae81ff">97</span>,<span style="color:#ae81ff">143</span>,<span style="color:#ae81ff">156</span>,<span style="color:#ae81ff">120</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">56</span>,<span style="color:#ae81ff">105</span>,<span style="color:#ae81ff">201</span>,<span style="color:#ae81ff">159</span>,<span style="color:#ae81ff">80</span>,<span style="color:#ae81ff">222</span>,<span style="color:#ae81ff">159</span>,<span style="color:#ae81ff">201</span>,<span style="color:#ae81ff">79</span>,<span style="color:#ae81ff">88</span>,<span style="color:#ae81ff">72</span>,...<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>         #{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;accept-encoding&#34;</span><span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;gzip&#34;</span><span style="color:#f92672">&gt;&gt;</span>}},
</span></span><span style="display:flex;"><span>        {<span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>         [{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-type&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;text/plain&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>          {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;vary&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;accept-encoding&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>          {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-encoding&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;gzip&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>          {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-length&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;28&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>          {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;age&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;8&#34;</span><span style="color:#f92672">&gt;&gt;</span>}],
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">31</span>,<span style="color:#ae81ff">139</span>,<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">115</span>,<span style="color:#ae81ff">78</span>,<span style="color:#ae81ff">76</span>,<span style="color:#ae81ff">206</span>,<span style="color:#ae81ff">72</span>,<span style="color:#ae81ff">85</span>,<span style="color:#ae81ff">200</span>,<span style="color:#ae81ff">77</span>,<span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">162</span>,<span style="color:#ae81ff">221</span>,...<span style="color:#f92672">&gt;&gt;</span>}}}
</span></span></code></pre></div><p>Here we&rsquo;ve lowered the threshold for compressing from the default of 1000 bytes,
and the compressed content is actually bigger than the uncompressed. Which is why there&rsquo;s a
threshold in the first place.</p>
<p>To avoid compressing binary responses, only a subset of MIME types are compressed
by default. Refer to the <code>auto_compress_mime_types</code> option to get the complete list.</p>
<p>Once the response is cached, <code>http_cache</code> responds to range requests:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span><span style="color:#ae81ff">10</span><span style="color:#f92672">&gt;</span> http_cache:get({<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">&gt;&gt;</span>, <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;http://example.org&#34;</span><span style="color:#f92672">&gt;&gt;</span>, [{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;range&#34;</span><span style="color:#f92672">&gt;&gt;</span>, <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;bytes=0-4&#34;</span><span style="color:#f92672">&gt;&gt;</span>}], <span style="color:#f92672">&lt;&lt;&gt;&gt;</span>}, Opts).
</span></span><span style="display:flex;"><span>{fresh,{{ <span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">66</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">235</span>,<span style="color:#ae81ff">59</span>,<span style="color:#ae81ff">78</span>,<span style="color:#ae81ff">212</span>,<span style="color:#ae81ff">170</span>,<span style="color:#ae81ff">99</span>,<span style="color:#ae81ff">22</span>,<span style="color:#ae81ff">66</span>,<span style="color:#ae81ff">97</span>,<span style="color:#ae81ff">143</span>,<span style="color:#ae81ff">156</span>,<span style="color:#ae81ff">120</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">56</span>,<span style="color:#ae81ff">105</span>,<span style="color:#ae81ff">201</span>,<span style="color:#ae81ff">159</span>,<span style="color:#ae81ff">80</span>,<span style="color:#ae81ff">222</span>,<span style="color:#ae81ff">159</span>,<span style="color:#ae81ff">201</span>,<span style="color:#ae81ff">79</span>,<span style="color:#ae81ff">88</span>,<span style="color:#ae81ff">72</span>,...<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>         #{}},
</span></span><span style="display:flex;"><span>        {<span style="color:#ae81ff">206</span>,
</span></span><span style="display:flex;"><span>         [{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-type&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;text/plain&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>          {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-range&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;bytes 0-4/8&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>          {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-length&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;5&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>          {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;age&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;60&#34;</span><span style="color:#f92672">&gt;&gt;</span>}],
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;Cache&#34;</span><span style="color:#f92672">&gt;&gt;</span>}}}
</span></span></code></pre></div><p>This may help supporting <code>&lt;video/&gt;</code> players for instance, that use range requests to skip to a
specific time of the video. Caching partial responses (<code>206 Partial Content</code>) is not supported
by <code>http_cache</code>, in this scenario it would come at the cost of loading the full video on the first
request.</p>
<p>Revalidation is supported with the
<a href="https://hexdocs.pm/http_cache/http_cache.html#cache/4"><code>http_cache:cache/4</code></a> function. It consists
in sending a conditional request (with <code>if-modified-since</code> and <code>if-none-match</code>) and analyzing the
response. If <code>304 Not Modified</code> is returned by the origin server, the stored response is updated and
returned.</p>
<p>Responses can be tagged and later invalidated by tag (called alternate key) with
<a href="https://hexdocs.pm/http_cache/http_cache.html#invalidate_by_alternate_key/2"><code>http_cache:invalidate_by_alternate_key/2</code></a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span> http_cache:<span style="color:#a6e22e">cache</span>(Req, Resp, Opts#{alternate_keys <span style="color:#f92672">=&gt;</span> [some_key]}).
</span></span><span style="display:flex;"><span>{ok,{<span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>     [{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-type&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;text/plain&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>      {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-length&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;8&#34;</span><span style="color:#f92672">&gt;&gt;</span>}],
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;Cache me&#34;</span><span style="color:#f92672">&gt;&gt;</span>}}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span><span style="color:#f92672">&gt;</span> http_cache:get(Req, Opts).
</span></span><span style="display:flex;"><span>{fresh,{{ <span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">66</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">235</span>,<span style="color:#ae81ff">59</span>,<span style="color:#ae81ff">78</span>,<span style="color:#ae81ff">212</span>,<span style="color:#ae81ff">170</span>,<span style="color:#ae81ff">99</span>,<span style="color:#ae81ff">22</span>,<span style="color:#ae81ff">66</span>,<span style="color:#ae81ff">97</span>,<span style="color:#ae81ff">143</span>,<span style="color:#ae81ff">156</span>,<span style="color:#ae81ff">120</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">56</span>,<span style="color:#ae81ff">105</span>,<span style="color:#ae81ff">201</span>,<span style="color:#ae81ff">159</span>,<span style="color:#ae81ff">80</span>,<span style="color:#ae81ff">222</span>,<span style="color:#ae81ff">159</span>,<span style="color:#ae81ff">201</span>,<span style="color:#ae81ff">79</span>,<span style="color:#ae81ff">88</span>,<span style="color:#ae81ff">72</span>,...<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>         #{}},
</span></span><span style="display:flex;"><span>        {<span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>         [{<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-type&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;text/plain&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>          {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;content-length&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;8&#34;</span><span style="color:#f92672">&gt;&gt;</span>},
</span></span><span style="display:flex;"><span>          {<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;age&#34;</span><span style="color:#f92672">&gt;&gt;</span>,<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;4&#34;</span><span style="color:#f92672">&gt;&gt;</span>}],
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;Cache me&#34;</span><span style="color:#f92672">&gt;&gt;</span>}}}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span><span style="color:#f92672">&gt;</span> http_cache:<span style="color:#a6e22e">invalidate_by_alternate_key</span>(some_key, Opts).
</span></span><span style="display:flex;"><span>{ok,<span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7</span><span style="color:#f92672">&gt;</span> http_cache:get(Req, Opts).
</span></span><span style="display:flex;"><span>miss
</span></span></code></pre></div><p>Resources can also simply be invalidated by URL (see
<a href="https://hexdocs.pm/http_cache/http_cache.html#invalidate_url/2"><code>http_cache:invalidate_url/2</code></a>).</p>
<p>If you&rsquo;re into REST APIs, you might be interested by the <code>ignore_query_params_order</code> option. As its
name suggests, it rearranges query parameters so that whatever their order, it&rsquo;ll find matching
cached responses.</p>
<p>An HTTP cache can be:</p>
<ul>
<li>a shared cache - cached responses are shared among all users</li>
<li>a private cache - cached responses are per user, and may contain private information. In this
case, you must use the <code>bucket</code> option to specify to which user the cache response belongs</li>
</ul>
<p>Almost all of <a href="https://www.rfc-editor.org/rfc/rfc9111.html">RFC9111</a> is implemented, except for
caching partial responses and combining them when they&rsquo;re adjacent.</p>
<h2 id="associated-libraries">Associated libraries</h2>
<p>So far, <code>http_cache</code> is boring because it doesn&rsquo;t do anything useful. It&rsquo;s meant to be used by
other higher-level libraries. 2 of them were released along with <code>http_cache</code>.</p>
<p>First is <a href="https://github.com/tanguilp/plug_http_cache"><code>plug_http_cache</code></a>. A simple Plug that
automatically caches responses (when <code>cache-control</code> header allows it) and is simple to configure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span><span style="color:#66d9ef">defmodule</span> <span style="color:#a6e22e">SimpleAPIWeb.Router</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">use</span> <span style="color:#a6e22e">SimpleAPIWeb</span>, <span style="color:#e6db74">:router</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  pipeline <span style="color:#e6db74">:api</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    plug <span style="color:#e6db74">:accepts</span>, [<span style="color:#e6db74">&#34;json&#34;</span>]
</span></span><span style="display:flex;"><span>    plug <span style="color:#a6e22e">PlugHTTPCache</span>, <span style="color:#a6e22e">Application</span><span style="color:#f92672">.</span>compile_env(<span style="color:#e6db74">:simple_api</span>, <span style="color:#e6db74">:plug_http_cache_opts</span>)
</span></span><span style="display:flex;"><span>    plug <span style="color:#a6e22e">PlugCacheControl</span>, <span style="color:#e6db74">directives</span>: [<span style="color:#e6db74">:public</span>, <span style="color:#e6db74">s_maxage</span>: <span style="color:#ae81ff">600</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  scope <span style="color:#e6db74">&#34;/api&#34;</span>, <span style="color:#a6e22e">SimpleAPIWeb</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    pipe_through <span style="color:#e6db74">:api</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    get <span style="color:#e6db74">&#34;/products&#34;</span>, <span style="color:#a6e22e">ProductController</span>, <span style="color:#e6db74">:index</span>
</span></span><span style="display:flex;"><span>    get <span style="color:#e6db74">&#34;/products/:id&#34;</span>, <span style="color:#a6e22e">ProductController</span>, <span style="color:#e6db74">:show</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>and that&rsquo;s it! All responses will be cached. If you need finer control of which responses
are cached and which aren&rsquo;t, you can set cache control headers at the controller level instead of
in the router.</p>
<p><a href="https://hexdocs.pm/plug_http_cache/PlugHTTPCache.StaleIfError.html"><code>PlugHTTPCache.StaleIfError</code></a>,
when enabled, allows returning stale (not fresh) content when something on the backend fails. Think
restarting DB, network glitches or full connection pool. One just has to set the <code>stale-if-error</code>
cache control header in the cached response:</p>
<pre tabindex="0"><code>cache-control: max-age=300, stale-if-error=3600
</code></pre><p>and <code>plug_http_cache</code> will return the cached response for 5 minutes, and for an additional
60 minutes should the backend be unavailable (in Phoenix&rsquo;s terms - if an exception is raised).</p>
<p>The second library is <a href="https://github.com/tanguilp/tesla_http_cache"><code>TeslaHTTPCache</code></a>. This is an
HTTP caching middleware for Tesla:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span>iex<span style="color:#f92672">&gt;</span> client <span style="color:#f92672">=</span> <span style="color:#a6e22e">Tesla</span><span style="color:#f92672">.</span>client([{<span style="color:#a6e22e">TeslaHTTPCache</span>, %{<span style="color:#e6db74">store</span>: <span style="color:#e6db74">:http_cache_store_process</span>}}])
</span></span><span style="display:flex;"><span>%<span style="color:#a6e22e">Tesla.Client</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">fun</span>: <span style="color:#66d9ef">nil</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">pre</span>: [{<span style="color:#a6e22e">TeslaHTTPCache</span>, <span style="color:#e6db74">:call</span>, [%{<span style="color:#e6db74">store</span>: <span style="color:#e6db74">:http_cache_store_process</span>}]}],
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">post</span>: [],
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">adapter</span>: <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>iex<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Tesla</span><span style="color:#f92672">.</span>get!(client, <span style="color:#e6db74">&#34;http://perdu.com&#34;</span>)
</span></span><span style="display:flex;"><span>%<span style="color:#a6e22e">Tesla.Env</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">method</span>: <span style="color:#e6db74">:get</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">url</span>: <span style="color:#e6db74">&#34;http://perdu.com&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">query</span>: [],
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">headers</span>: [
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;cache-control&#34;</span>, <span style="color:#e6db74">&#34;max-age=600&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;vary&#34;</span>, <span style="color:#e6db74">&#34;Accept-Encoding,User-Agent&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;content-type&#34;</span>, <span style="color:#e6db74">&#34;text/html&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;expires&#34;</span>, <span style="color:#e6db74">&#34;Sat, 22 Apr 2023 14:25:11 GMT&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;last-modified&#34;</span>, <span style="color:#e6db74">&#34;Thu, 02 Jun 2016 06:01:08 GMT&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;content-length&#34;</span>, <span style="color:#e6db74">&#34;204&#34;</span>},
</span></span><span style="display:flex;"><span>    ... (omitted <span style="color:#66d9ef">for</span> brevity)
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">body</span>: <span style="color:#e6db74">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Vous Etes Perdu ?&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Perdu sur l&#39;Internet ?&lt;/h1&gt;&lt;h2&gt;Pas de panique, on va vous aider&lt;/h2&gt;&lt;strong&gt;&lt;pre&gt;    * &lt;----- vous &amp;ecirc;tes ici&lt;/pre&gt;&lt;/strong&gt;&lt;/body&gt;&lt;/html&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">status</span>: <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">opts</span>: [],
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">__module__</span>: <span style="color:#a6e22e">Tesla</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">__client__</span>: %<span style="color:#a6e22e">Tesla.Client</span>{...}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>iex<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Tesla</span><span style="color:#f92672">.</span>get!(client, <span style="color:#e6db74">&#34;http://perdu.com&#34;</span>)
</span></span><span style="display:flex;"><span>%<span style="color:#a6e22e">Tesla.Env</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">method</span>: <span style="color:#e6db74">:get</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">url</span>: <span style="color:#e6db74">&#34;http://perdu.com&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">query</span>: [],
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">headers</span>: [
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;cache-control&#34;</span>, <span style="color:#e6db74">&#34;max-age=600&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;vary&#34;</span>, <span style="color:#e6db74">&#34;Accept-Encoding,User-Agent&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;content-type&#34;</span>, <span style="color:#e6db74">&#34;text/html&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;expires&#34;</span>, <span style="color:#e6db74">&#34;Sat, 22 Apr 2023 14:25:11 GMT&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;last-modified&#34;</span>, <span style="color:#e6db74">&#34;Thu, 02 Jun 2016 06:01:08 GMT&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;content-length&#34;</span>, <span style="color:#e6db74">&#34;204&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;age&#34;</span>, <span style="color:#e6db74">&#34;8&#34;</span>}
</span></span><span style="display:flex;"><span>    ... (omitted <span style="color:#66d9ef">for</span> brevity)
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">body</span>: <span style="color:#e6db74">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Vous Etes Perdu ?&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Perdu sur l&#39;Internet ?&lt;/h1&gt;&lt;h2&gt;Pas de panique, on va vous aider&lt;/h2&gt;&lt;strong&gt;&lt;pre&gt;    * &lt;----- vous &amp;ecirc;tes ici&lt;/pre&gt;&lt;/strong&gt;&lt;/body&gt;&lt;/html&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">status</span>: <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">opts</span>: [],
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">__module__</span>: <span style="color:#a6e22e">Tesla</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">__client__</span>: %<span style="color:#a6e22e">Tesla.Client</span>{...}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Noticed the <code>age</code> header in the second response? It means the response has been returned by
the cache.</p>
<p>Work is underway to implement the same type of middleware for the
<a href="https://github.com/wojtekmach/req"><code>req</code></a> library.</p>
<p>Any layer dealing with HTTP request/response cycle could use <code>http_cache</code>. I&rsquo;m thinking of:</p>
<ul>
<li>a Cowboy middleware</li>
<li>Erlang and Elixir reverse proxies (such as
<a href="https://hex.pm/packages/reverse_proxy_plug"><code>reverse_proxy_plug</code></a>)</li>
</ul>
<h2 id="stores">Stores</h2>
<p>You might have noticed the <code>store</code> parameter. <code>http_cache</code> doesn&rsquo;t store anything, and in the
previous example we used the
<a href="https://hexdocs.pm/http_cache/http_cache_store_process.html"><code>http_cache_store_process</code></a> store.
As its name suggests, it caches responses in the current process. Useful for testing, not much for
production use.</p>
<p><code>http_cache</code> comes with 2 LRU stores:</p>
<ul>
<li><a href="https://github.com/tanguilp/http_cache_store_memory"><code>http_cache_store_memory</code></a>: responses are
stored in memory (ETS)</li>
<li><a href="https://github.com/tanguilp/http_cache_store_disk"><code>http_cache_store_disk</code></a>: responses are
stored on disk</li>
</ul>
<p>Why not a store that stores responses in both memory and on disk? Because it&rsquo;s not needed.
If you look at <code>http_cache</code> types, you might notice that a returned response&rsquo;s body can either
be IOdata or a pointer to a file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span><span style="color:#f92672">-</span>type response() <span style="color:#f92672">::</span> {status(), headers(), body() <span style="color:#f92672">|</span> sendfile()}<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>type body() <span style="color:#f92672">::</span> iodata()<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>type sendfile() <span style="color:#f92672">::</span>
</span></span><span style="display:flex;"><span>    {sendfile,
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">Offset</span> <span style="color:#f92672">::</span> non_neg_integer(),
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">Length</span> <span style="color:#f92672">::</span> non_neg_integer() <span style="color:#f92672">|</span> all,
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">Path</span> <span style="color:#f92672">::</span> binary()}<span style="color:#f92672">.</span>
</span></span></code></pre></div><p>When using <code>http_cache_store_disk</code>, a <code>sendfile()</code> response body is returned. It&rsquo;s up to the
user to get the file content from the disk. <code>plug_http_cache</code>, however, doesn&rsquo;t do that
but forwards the information to the adapter, that uses the <code>sendfile</code> <em>system call</em>: the kernel sends
the content of the file directly to the socket, and caches the content in memory. The file is never
loaded in userland. This is extremely efficient.</p>
<p>Both these stores support clustering. As long as they are in the same cluster and the feature is
enabled, they will:</p>
<ul>
<li>exchange cached responses between them</li>
<li>warm up joining nodes by sending them the most recently used responses</li>
<li>broadcast invalidation request</li>
</ul>
<p>Both also implement backpressure mechanisms. An HTTP cache should never block a request/response
cycle, which is why calls are non-blocking and caching can be stopped when some limits are reached:</p>
<ul>
<li>too many responses are cached - a cleanup process is started as soon as possible to nuke least
recently used entries</li>
<li>too many responses are queued for caching - new ones are dropped</li>
</ul>
<p>This is essential to make sure the system remains stable. As a consequence, one cannot make any
assumption as to whether a response will be cached or not.</p>
<p>Both backend emit telemetry events (<code>http_cache</code> as well, by the way). You can take a look at
<a href="https://github.com/tanguilp/plug_http_cache_demo"><code>plug_http_cache_demo</code></a> where telemetry events
are transformed into nice dashboards:</p>
<p><img src="https://raw.githubusercontent.com/tanguilp/plug_http_cache/master/media/grafana.png#center" alt="plug_http_cache_demo dashboard"></p>
<p>(Don&rsquo;t take the numbers for real-world values - this is a testing environment with 3 Phoenix
instances running in Docker and Tsung sending tons of requests - from the same old Thinkpad!)</p>
<h2 id="programmable-caching-subsystem">Programmable caching subsystem</h2>
<p>Since HTTP caching is performed within the BEAM, cached objects are directly available to users.
The language to query them is, well, HTTP.</p>
<p>This enables optimizations that would otherwise be more complicated to implemented. For instance,
how to look up in the cache for each individual resource of a batch request (<code>/resources?id=1,2,3</code>)?
Let&rsquo;s try in Elixir&rsquo;s Phoenix controller:</p>
<p><code>lib/simple_api_web/product_controller.ex</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span><span style="color:#66d9ef">defmodule</span> <span style="color:#a6e22e">SimpleAPIWeb.ProductController</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">use</span> <span style="color:#a6e22e">SimpleAPIWeb</span>, <span style="color:#e6db74">:controller</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">require</span> <span style="color:#a6e22e">Logger</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">alias</span> <span style="color:#a6e22e">SimpleAPI.Products</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@http_cache_opts</span> <span style="color:#a6e22e">Application</span><span style="color:#f92672">.</span>compile_env(<span style="color:#e6db74">:simple_api</span>, <span style="color:#e6db74">:plug_http_cache_opts</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> index(conn, %{<span style="color:#e6db74">&#34;ids&#34;</span> <span style="color:#f92672">=&gt;</span> ids}) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    products <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      ids
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> <span style="color:#a6e22e">String</span><span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;,&#34;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> <span style="color:#a6e22e">Task</span><span style="color:#f92672">.</span>async_stream(<span style="color:#66d9ef">fn</span> id <span style="color:#f92672">-&gt;</span> get_from_cache(id) <span style="color:#f92672">||</span> <span style="color:#a6e22e">Products</span><span style="color:#f92672">.</span>get_product!(id) <span style="color:#66d9ef">end</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> <span style="color:#a6e22e">Enum</span><span style="color:#f92672">.</span>map(<span style="color:#66d9ef">fn</span> {<span style="color:#e6db74">:ok</span>, value} <span style="color:#f92672">-&gt;</span> value <span style="color:#66d9ef">end</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    render(conn, <span style="color:#e6db74">:index</span>, <span style="color:#e6db74">products</span>: products)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> show(conn, %{<span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=&gt;</span> id}) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    product <span style="color:#f92672">=</span> <span style="color:#a6e22e">Products</span><span style="color:#f92672">.</span>get_product!(id)
</span></span><span style="display:flex;"><span>    render(conn, <span style="color:#e6db74">:show</span>, <span style="color:#e6db74">product</span>: product)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> get_from_cache(id) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;GET&#34;</span>, url(<span style="color:#e6db74">~p&#34;/api/products/</span><span style="color:#e6db74">#{</span>id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>), [], <span style="color:#e6db74">&#34;&#34;</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> <span style="color:#e6db74">:http_cache</span><span style="color:#f92672">.</span>get(<span style="color:#a6e22e">@http_cache_opts</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> process_cache_response()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> process_cache_response({<span style="color:#e6db74">:fresh</span>, {resp_ref, {_status, _headers, {<span style="color:#e6db74">:sendfile</span>, _, _, path}}}}) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">File</span><span style="color:#f92672">.</span>read(path) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      {<span style="color:#e6db74">:ok</span>, body} <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">:http_cache</span><span style="color:#f92672">.</span>notify_response_used(resp_ref, <span style="color:#a6e22e">@http_cache_opts</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">:from_cache</span>, body}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      {<span style="color:#e6db74">:error</span>, _} <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> process_cache_response({<span style="color:#e6db74">:fresh</span>, {resp_ref, {_status, _headers, body}}}) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">:http_cache</span><span style="color:#f92672">.</span>notify_response_used(resp_ref, <span style="color:#a6e22e">@http_cache_opts</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">:from_cache</span>, body}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> process_cache_response(_) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p><code>lib/simple_api_web/product_json.ex</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span><span style="color:#66d9ef">defmodule</span> <span style="color:#a6e22e">SimpleAPIWeb.ProductJSON</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">alias</span> <span style="color:#a6e22e">SimpleAPI.Products.Product</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@doc</span> <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Renders a list of products.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> index(%{<span style="color:#e6db74">products</span>: products}) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(product <span style="color:#f92672">&lt;-</span> products, <span style="color:#e6db74">do</span>: data(product))
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@doc</span> <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Renders a single product.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> show(%{<span style="color:#e6db74">product</span>: product}) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    data(product)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> data(%<span style="color:#a6e22e">Product</span>{} <span style="color:#f92672">=</span> product) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    %{
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">id</span>: product<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">name</span>: product<span style="color:#f92672">.</span>name
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">defp</span> data({<span style="color:#e6db74">:from_cache</span>, body}) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Jason.Fragment</span><span style="color:#f92672">.</span>new(body)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>(Note the opportune use of
<a href="https://hexdocs.pm/jason/Jason.Fragment.html#new/1"><code>Jason.Fragment.new/1</code></a> that avoids decoding
the individual JSON payload and encoding it again.)</p>
<p>When using a traditional DB, we&rsquo;d probably not need to do that (especially retrieving products one
by one). This might come handy, however, when hitting external APIs, or slower database like some
NoSQL DBs.</p>
<p>We could do the opposite and cache individual products when processing a list of products. In
practice, we&rsquo;d need to encode the body (easy) and set the headers like Phoenix would have done
for an individual request (harder).</p>
<p>Beyond HTTP, <code>http_cache</code> can actually be used to cache any data, such as GraphQL for example. As
long as a method, a URI and cache-control headers are set, <code>http_cache</code> won&rsquo;t care.</p>
<h2 id="conclusion">Conclusion</h2>
<p><code>http_cache</code> is intended to give another option to the BEAM world when it comes to HTTP caching
with a solution that:</p>
<ul>
<li>is native BEAM code and doesn&rsquo;t require additional infrastructure dependencies</li>
<li>takes advantages of BEAM clustering capabilities</li>
<li>uses standard BEAM tools (telemetry&hellip;)</li>
<li>conforms as much as possible to RFCs</li>
<li>and remains simple</li>
</ul>
<p><code>http_cache</code> is not thoroughly load-tested at the time of writing, due to lack of time and resources.
Hopefully, most of the work is done to provide with a viable HTTP caching layer on the BEAM, but feel
free to leave feedback if you&rsquo;re using it, or if you encountered problems with these libraries. Until
then it&rsquo;ll remain pre v1.0.</p>
<p>I&rsquo;m also working on licensed versions of <a href="https://hex.codecodeship.com/package/http_cache_pro">some</a>
of these <a href="https://hex.codecodeship.com/package/http_cache_store_disk_pro">libraries</a>, available on
the excellent <a href="https://codecodeship.com/">codecodeship</a> platform, but that&rsquo;s a story for another day.</p>

		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/http-caching">HTTP caching</a></li>
					
					<li><a href="/tags/elixir">Elixir</a></li>
					
					<li><a href="/tags/erlang">Erlang</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/tanguilp/" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://www.linkedin.com/in/tanguil/" rel="me" title="Linkedin"><i data-feather="linkedin"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2025  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
